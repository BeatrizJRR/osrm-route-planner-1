<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Planeador de Rotas</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    :root { --accent:#2b7cff; --danger:#ff4444; --success:#44aa44; }
    *{ margin:0; padding:0; box-sizing:border-box; }
    html,body{ height:100%; font-family:system-ui,Arial,sans-serif; background:#f0f0f0; }
    .container{ display:flex; height:100vh; gap:10px; padding:10px; }
    .sidebar{ width:350px; background:white; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,.1); padding:15px; display:flex; flex-direction:column; gap:12px; overflow:auto; }
    .sidebar h1{ font-size:20px; margin-bottom:8px; }
    .form-group{ display:flex; flex-direction:column; gap:4px; }
    .form-group label{ font-size:13px; font-weight:600; color:#333; }
    .form-group input, .form-group select{ padding:8px; border:1px solid #ddd; border-radius:4px; font-size:14px; }
    .form-group input:focus, .form-group select:focus{ outline:none; border-color:var(--accent); box-shadow:0 0 0 2px rgba(43,124,255,.1); }
    .button-group{ display:flex; gap:8px; flex-wrap:wrap; }
    .btn{ padding:8px 12px; border:none; border-radius:4px; cursor:pointer; font-size:13px; font-weight:600; transition:all .2s; }
    .btn-primary{ background:var(--accent); color:white; }
    .btn-primary:hover{ background:#1e5fbf; }
    .btn-secondary{ background:#eee; color:#333; }
    .btn-secondary:hover{ background:#ddd; }
    .btn-danger{ background:var(--danger); color:white; }
    .btn-success{ background:var(--success); color:white; }
    .alert{ padding:10px; border-radius:4px; font-size:13px; margin-bottom:8px; }
    .alert-error{ background:#ffebee; color:#c62828; border:1px solid #ef5350; }
    .alert-success{ background:#e8f5e9; color:#2e7d32; border:1px solid #81c784; }
    .alert-info{ background:#e3f2fd; color:#1565c0; border:1px solid #64b5f6; }
    .list-label{ font-size:12px; font-weight:600; color:#666; margin-top:8px; }
    .points-list{ flex:1; overflow:auto; padding:8px; background:#fafafa; border-radius:4px; min-height:100px; }
    .point-item{ padding:8px; margin-bottom:6px; background:white; border-radius:4px; border-left:3px solid var(--accent); display:flex; flex-direction:row; justify-content:space-between; align-items:flex-start; gap:8px; font-size:13px; flex-wrap:wrap; }
    .point-item > div:first-child { flex:1; min-width:0; }
    .point-item .label{ font-weight:600; }
    .point-item .coords{ font-size:11px; color:#999; }
    .point-item button{ padding:4px 8px; font-size:11px; background:#ff9999; color:white; border:none; border-radius:3px; cursor:pointer; white-space:nowrap; flex-shrink:0; }
    .transport-buttons { display: flex; flex-direction: column; gap: 8px; }
    .transport-buttons label { font-size: 12px; font-weight: 600; color: #333; }
    .transport-modes { display: flex; gap: 6px; }
    .transport-modes button { flex: 1; padding: 10px 12px; border: 2px solid #ddd; border-radius: 6px; background: white; color: #333; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; gap: 4px; }
    .transport-modes button:hover { border-color: var(--accent); background: #f5f9ff; }
    .transport-modes button.active { border-color: var(--accent); background: var(--accent); color: white; box-shadow: 0 4px 12px rgba(43,124,255,.2); }
    .transport-modes button span { font-size: 18px; }
    .destinations-section { display: flex; flex-direction: column; gap: 8px; }
    .destinations-header { display: flex; justify-content: space-between; align-items: center; }
    .destinations-header label { font-size: 12px; font-weight: 600; color: #333; }
    .destinations-header button { padding: 4px 8px; font-size: 18px; background: none; border: 2px solid var(--accent); border-radius: 4px; color: var(--accent); cursor: pointer; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
    .destinations-header button:hover { background: var(--accent); color: white; }
    .destino-input-group { display: flex; gap: 6px; align-items: flex-end; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid #eee; }
    .destino-input-group:last-child { margin-bottom: 0; padding-bottom: 0; border-bottom: none; }
    .destino-input-group input { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; position: relative; }
    .destino-input-group button { padding: 6px 10px; font-size: 13px; background: #ff6b6b; color: white; border: none; border-radius: 4px; cursor: pointer; transition: all 0.2s; min-width: 80px; }
    .destino-input-group button:hover { background: #ff5252; }
    .search-suggestions { position: absolute; background: white; border: 1px solid #ddd; border-top: none; border-radius: 0 0 4px 4px; max-height: 200px; overflow-y: auto; width: 100%; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,.1); }
    .suggestion-item { padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #eee; font-size: 13px; }
    .suggestion-item:hover { background: #f5f9ff; color: var(--accent); }
    .suggestion-item:last-child { border-bottom: none; }
    #map{ flex:1; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,.1); }
    @media(max-width:900px){ .container{ flex-direction:column; } .sidebar{ width:100%; order:2; } #map{ order:1; height:60vh; } }
  </style>
</head>
<body>
  <div class="container">
    <aside class="sidebar">
      <h1>üó∫Ô∏è Planeador de Rotas</h1>

      <!-- Alertas -->
      <div id="alerts"></div>

      <!-- Modo de Transporte -->
      <div class="transport-buttons">
        <label>Modo de Transporte</label>
        <div class="transport-modes" id="transportModes">
          <button class="transport-btn active" data-mode="driving" title="Carro (driving)">
            <span>üöó</span>
            <div>Carro</div>
          </button>
          <button class="transport-btn" data-mode="walking" title="A p√© (walking)">
            <span>üö∂</span>
            <div>A P√©</div>
          </button>
          <button class="transport-btn" data-mode="cycling" title="Bicicleta (cycling)">
            <span>üö¥</span>
            <div>Bicicleta</div>
          </button>
        </div>
      </div>


      <!-- Origem -->
      <div class="form-group">
        <label>Origem (endere√ßo ou lat,lng)</label>
        <input type="text" id="originInput" placeholder="Ex: Lisboa ou 38.7,-9.1" />
      </div>

      <!-- Destinos -->
      <div class="destinations-section">
        <div class="destinations-header">
          <label>Destinos</label>
          <button id="addDestinoBtn" title="Adicionar destino">+</button>
        </div>
        <div id="destinosContainer">
          <div class="destino-input-group">
            <input type="text" class="destino-input" placeholder="Ex: Porto ou 41.1,-8.6" data-index="0" />
            <button class="destino-remove" style="display:none;">Remover</button>
          </div>
        </div>
      </div>

      <!-- Bot√µes de A√ß√£o -->
      <div class="button-group">
        <button class="btn btn-primary" id="calcRoute">Calcular Rota</button>
        <button class="btn btn-secondary" id="clear">Limpar</button>
        <button class="btn btn-secondary" id="geolocate">Minha Localiza√ß√£o</button>
      </div>

      <!-- Lista de Pontos -->
      <div class="list-label">Pontos no Mapa</div>
      <div class="points-list" id="pointsList">
        <div style="color:#999; font-size:13px;">N√£o definiu ainda nenhum ponto. Clique no mapa ou insira origem e destino.</div>
      </div>

    </aside>

    <div id="map"></div>
  </div>

  <script>
    // INICIALIZAR MAPA
    const mapElement = L.map('map', { zoomControl:true }).setView([38.736946, -9.142685], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom:19,
      attribution:'¬© OpenStreetMap'
    }).addTo(mapElement);

    // ESTADO
    const state = {
      points: [],
      routeLayer: null,
      transportMode: 'driving'
    };

    // DOM
    const originInput = document.getElementById('originInput');
    const destinosContainer = document.getElementById('destinosContainer');
    const addDestinoBtn = document.getElementById('addDestinoBtn');
    const transportMode = document.getElementById('transportMode');
    const calcBtn = document.getElementById('calcRoute');
    const clearBtn = document.getElementById('clear');
    const geolocBtn = document.getElementById('geolocate');
    const pointsList = document.getElementById('pointsList');
    const alerts = document.getElementById('alerts');
    let destinoCounter = 1;

    // HELPER: mostrar alerta
    function showAlert(msg, type = 'info') {
      const div = document.createElement('div');
      div.className = 'alert alert-' + type;
      div.textContent = msg;
      alerts.appendChild(div);
      
      // "Validando..." (info azul) desaparece ap√≥s 30 segundos
      if (msg.includes('Validando')) {
        setTimeout(() => {
          div.remove();
        }, 30000); // 30 segundos
      }
      // Outros alertas (verde ‚úÖ, vermelho ‚ùå) ficam permanentes
    }

    // HELPER: limpar alertas
    function clearAlerts() {
      alerts.innerHTML = '';
    }

    // HELPER: validar e converter coordenadas
    function parseCoords(input) {
      const trimmed = input.trim();
      const parts = trimmed.split(',');
      if (parts.length === 2) {
        const lat = parseFloat(parts[0].trim());
        const lng = parseFloat(parts[1].trim());
        if (!isNaN(lat) && !isNaN(lng) && lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180) {
          return { lat, lng, name: `${lat.toFixed(4)}, ${lng.toFixed(4)}` };
        }
      }
      return null;
    }

    // HELPER: geocode com sugest√µes
    async function geocodeWithSuggestions(address) {
      try {
        const res = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(address)}&format=json&limit=5`);
        const data = await res.json();
        return data.map(place => ({
          lat: parseFloat(place.lat),
          lng: parseFloat(place.lon),
          name: place.display_name.split(',')[0],
          display: place.display_name
        }));
      } catch (e) {}
      return [];
    }

    // Fun√ß√£o para mostrar sugest√µes
    async function showSuggestions(input, container) {
      const value = input.value.trim();
      if (value.length < 2) return;

      // Se √© coordenada, n√£o mostra sugest√µes
      if (value.includes(',')) return;

      const suggestions = await geocodeWithSuggestions(value);
      if (suggestions.length === 0) return;

      const suggestionsDiv = document.createElement('div');
      suggestionsDiv.className = 'search-suggestions';
      suggestions.forEach(suggestion => {
        const item = document.createElement('div');
        item.className = 'suggestion-item';
        item.textContent = suggestion.display;
        item.onclick = () => {
          input.value = `${suggestion.lat.toFixed(5)},${suggestion.lng.toFixed(5)}`;
          suggestionsDiv.remove();
        };
        suggestionsDiv.appendChild(item);
      });

      // Remove antigas sugest√µes se existirem
      const old = container.querySelector('.search-suggestions');
      if (old) old.remove();

      container.appendChild(suggestionsDiv);

      // Remove sugest√µes ao clicar fora
      document.addEventListener('click', (e) => {
        if (e.target !== input) {
          setTimeout(() => suggestionsDiv.remove(), 100);
        }
      });
    }

    // HELPER: geocode simples (usa OSM Nominatim)
    async function geocode(address) {
      try {
        const res = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(address)}&format=json&limit=1`);
        const data = await res.json();
        if (data.length > 0) {
          const place = data[0];
          return { lat: parseFloat(place.lat), lng: parseFloat(place.lon), name: place.display_name.split(',')[0] };
        }
      } catch (e) {}
      return null;
    }

    // HELPER: adicionar ponto ao mapa
    function addPoint(lat, lng, name, isOrigin = false) {
      // Verificar se ponto j√° existe (evitar duplicatas)
      const exists = state.points.some(p => p.lat.toFixed(5) === lat.toFixed(5) && p.lng.toFixed(5) === lng.toFixed(5));
      if (exists) {
        console.log('Ponto j√° existe:', lat, lng);
        return;
      }

      const marker = L.marker([lat, lng], {
        icon: L.icon({
          iconUrl: `data:image/svg+xml;base64,${btoa('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="' + (isOrigin ? '#2b7cff' : '#ff6b6b') + '" width="32" height="32"><path d="M12 2C6.48 2 2 6.48 2 12c0 4.42 3.58 8.02 8 8.48V22h4v-1.52c4.42-.46 8-4.06 8-8.48 0-5.52-4.48-10-10-10zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11z"/></svg>')}`,
          iconSize: [32, 32],
          iconAnchor: [16, 32],
          popupAnchor: [0, -32]
        })
      }).addTo(mapElement).bindPopup(`<strong>${name}</strong><br/>${lat.toFixed(5)}, ${lng.toFixed(5)}`);

      state.points.push({ lat, lng, name, marker, isOrigin });
      console.log('Ponto adicionado:', name, 'Total:', state.points.length);
      renderPoints();
    }

    // HELPER: renderizar lista de pontos
    function renderPoints() {
      console.log('renderPoints chamada, total de pontos:', state.points.length);
      pointsList.innerHTML = '';
      
      if (state.points.length === 0) {
        pointsList.innerHTML = '<div style="color:#999; font-size:13px;">Nenhum ponto ainda.</div>';
        return;
      }
      
      state.points.forEach((p, i) => {
        console.log(`Renderizando ponto ${i}:`, p.name, p.lat, p.lng);
        const div = document.createElement('div');
        div.className = 'point-item';
        
        let label = 'üìç ' + p.name;
        if (p.isOrigin) label = 'üìç Origem';
        else if (p.name.startsWith('Destino')) label = 'üìç ' + p.name;
        
        const infoDiv = document.createElement('div');
        infoDiv.style.flex = '1';
        infoDiv.style.minWidth = '0';
        infoDiv.innerHTML = `
          <div class="label">${label}</div>
          <div class="coords">${p.lat.toFixed(5)}, ${p.lng.toFixed(5)}</div>
        `;
        
        const btn = document.createElement('button');
        btn.textContent = 'Remover';
        btn.style.whiteSpace = 'nowrap';
        btn.style.flexShrink = '0';
        btn.onclick = () => {
          mapElement.removeLayer(p.marker);
          state.points.splice(i, 1);
          renderPoints();
          if (state.routeLayer) { mapElement.removeLayer(state.routeLayer); state.routeLayer = null; }
        };
        
        div.appendChild(infoDiv);
        div.appendChild(btn);
        pointsList.appendChild(div);
      });
    }

    // ADICIONAR NOVO DESTINO
    function createDestinoGroup() {
      const newGroup = document.createElement('div');
      newGroup.className = 'destino-input-group';
      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'destino-input';
      input.placeholder = 'Ex: Porto ou 41.1,-8.6';
      input.dataset.index = destinoCounter;

      // Listener para sugest√µes de pesquisa
      let searchTimeout;
      input.addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          showSuggestions(input, newGroup);
        }, 300);
      });

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          calcBtn.click();
        }
      });

      const btn = document.createElement('button');
      btn.className = 'destino-remove';
      btn.textContent = 'Remover';
      btn.style.display = 'none';

      btn.addEventListener('click', () => {
        newGroup.remove();
        updateRemoveButtons();
      });

      newGroup.appendChild(input);
      newGroup.appendChild(btn);
      return newGroup;
    }

    addDestinoBtn.addEventListener('click', () => {
      const newGroup = createDestinoGroup();
      destinosContainer.appendChild(newGroup);
      destinoCounter++;
      updateRemoveButtons();
    });

    // Adicionar listeners no primeiro destino tamb√©m
    document.addEventListener('DOMContentLoaded', () => {
      const firstInput = document.querySelector('.destino-input');
      if (firstInput) {
        let searchTimeout;
        firstInput.addEventListener('input', (e) => {
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(() => {
            const group = firstInput.closest('.destino-input-group');
            showSuggestions(firstInput, group);
          }, 300);
        });

        firstInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            calcBtn.click();
          }
        });
      }

      const originInputSearch = document.getElementById('originInput');
      if (originInputSearch) {
        let searchTimeout;
        originInputSearch.addEventListener('input', (e) => {
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(() => {
            const group = originInputSearch.closest('.form-group');
            showSuggestions(originInputSearch, group);
          }, 300);
        });

        originInputSearch.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            calcBtn.click();
          }
        });
      }
    });

    // Atualizar visibilidade dos bot√µes remover
    function updateRemoveButtons() {
      const groups = document.querySelectorAll('.destino-input-group');
      groups.forEach((group, idx) => {
        const btn = group.querySelector('.destino-remove');
        btn.style.display = groups.length > 1 ? 'block' : 'none';
      });
    }

    // VALIDAR E CALCULAR ROTA
    calcBtn.addEventListener('click', async function() {
      // Limpar alertas anteriores
      clearAlerts();

      const originText = originInput.value.trim();
      const destinoInputs = document.querySelectorAll('.destino-input');
      const destinoTexts = Array.from(destinoInputs).map(inp => inp.value.trim()).filter(v => v);

      if (!originText || destinoTexts.length === 0) {
        showAlert('‚ö†Ô∏è Preencha origem e pelo menos um destino', 'error');
        return;
      }

      showAlert('üîÑ Validando par√¢metros...', 'info');

      // Validar origem
      let origin = parseCoords(originText) || (await geocode(originText));
      if (!origin) {
        showAlert(`‚ùå Origem "${originText}" n√£o encontrada.`, 'error');
        return;
      }

      // Validar destinos
      const destinos = [];
      for (let destinoText of destinoTexts) {
        const destino = parseCoords(destinoText) || (await geocode(destinoText));
        if (!destino) {
          showAlert(`‚ùå Destino "${destinoText}" n√£o encontrado.`, 'error');
          return;
        }
        destinos.push(destino);
      }

      showAlert(`‚úÖ Par√¢metros v√°lidos: ${destinos.length} destino(s) ‚Ä¢ ${state.transportMode}`, 'success');

      // N√ÉO limpar pontos existentes - apenas manter os que j√° est√£o
      // Apenas remover a rota anterior se existir
      if (state.routeLayer) { 
        mapElement.removeLayer(state.routeLayer); 
        state.routeLayer = null; 
      }

      // Calcular rota com OSRM (suporta waypoints)
      const profile = state.transportMode === 'driving' ? 'driving' : state.transportMode === 'cycling' ? 'cycling' : 'foot';
      let coords = `${origin.lng},${origin.lat}`;
      destinos.forEach(d => coords += `;${d.lng},${d.lat}`);
      const url = `https://router.project-osrm.org/route/v1/${profile}/${coords}?overview=full&geometries=geojson`;

      try {
        const res = await fetch(url);
        const data = await res.json();
        if (!data.routes || data.routes.length === 0) {
          showAlert('‚ùå Nenhuma rota encontrada', 'error');
          return;
        }
        const route = data.routes[0];
        const distKm = (route.distance / 1000).toFixed(1);
        const minutos = Math.round(route.duration / 60);

        if (state.routeLayer) mapElement.removeLayer(state.routeLayer);
        state.routeLayer = L.geoJSON(route.geometry, {
          style: { color: '#2b7cff', weight: 4, opacity: 0.8 }
        }).addTo(mapElement);
        mapElement.fitBounds(state.routeLayer.getBounds(), { padding: [50, 50] });

        showAlert(`‚úÖ Rota calculada: ${distKm} km ‚Ä¢ ${minutos} min (${state.transportMode})`, 'success');
      } catch (e) {
        showAlert('‚ùå Erro ao calcular rota: ' + e.message, 'error');
      }
    });

    // MUDAR MODO DE TRANSPORTE (Bot√µes)
    const transportBtns = document.querySelectorAll('.transport-btn');
    transportBtns.forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        transportBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        state.transportMode = btn.dataset.mode;
        const modeNames = { driving: 'Carro üöó', walking: 'A P√© üö∂', cycling: 'Bicicleta üö¥' };
        showAlert(`‚úÖ Modo alterado para: ${modeNames[state.transportMode]}`, 'success');
      });
    });

    // LIMPAR
    clearBtn.addEventListener('click', () => {
      state.points.forEach(p => mapElement.removeLayer(p.marker));
      state.points = [];
      if (state.routeLayer) { mapElement.removeLayer(state.routeLayer); state.routeLayer = null; }
      originInput.value = '';
      document.querySelectorAll('.destino-input').forEach(inp => inp.value = '');
      renderPoints();
      showAlert('üóëÔ∏è Mapa limpo', 'info');
    });

    // GEOLOCALIZA√á√ÉO
    geolocBtn.addEventListener('click', () => {
      if (!navigator.geolocation) {
        showAlert('Geolocaliza√ß√£o n√£o suportada', 'error');
        return;
      }
      navigator.geolocation.getCurrentPosition(pos => {
        const { latitude: lat, longitude: lng } = pos.coords;
        mapElement.setView([lat, lng], 14);
        originInput.value = `${lat.toFixed(5)},${lng.toFixed(5)}`;
        // Adicionar ao mapa e √† lista
        addPoint(lat, lng, 'Minha Localiza√ß√£o', true);
        showAlert(`‚úÖ Sua posi√ß√£o: ${lat.toFixed(5)}, ${lng.toFixed(5)}`, 'success');
      }, () => showAlert('Erro ao obter localiza√ß√£o', 'error'));
    });

    // Click no mapa para adicionar pontos
    mapElement.on('click', (e) => {
      console.log('Clique no mapa:', e.latlng);
      const { lat, lng } = e.latlng;
      const isOrigin = state.points.length === 0;
      const pointName = isOrigin ? 'Origem' : `Destino ${state.points.length}`;
      console.log('Adicionando ponto:', pointName, isOrigin);
      addPoint(lat, lng, pointName, isOrigin);
      if (isOrigin) originInput.value = `${lat.toFixed(5)},${lng.toFixed(5)}`;
      else {
        // Adiciona ao primeiro destino vazio dispon√≠vel
        const destInputs = document.querySelectorAll('.destino-input');
        for (let input of destInputs) {
          if (!input.value.trim()) {
            input.value = `${lat.toFixed(5)},${lng.toFixed(5)}`;
            break;
          }
        }
      }
    });

    // Invalidar tamanho do mapa (WebView fix)
    setTimeout(() => mapElement.invalidateSize(true), 300);
    window.addEventListener('resize', () => mapElement.invalidateSize(true));

    // Log de inicializa√ß√£o
    console.log('=== App inicializada ===');
    console.log('pointsList element:', pointsList);
    console.log('originInput element:', originInput);
    console.log('state:', state);
  </script>
</body>
</html>