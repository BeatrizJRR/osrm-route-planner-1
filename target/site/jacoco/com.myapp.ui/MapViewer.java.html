<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="pt"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MapViewer.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">osrm-route-planner</a> &gt; <a href="index.source.html" class="el_package">com.myapp.ui</a> &gt; <span class="el_source">MapViewer.java</span></div><h1>MapViewer.java</h1><pre class="source lang-java linenums">package com.myapp.ui;

import java.util.ArrayList;
import java.util.List;

import com.myapp.model.POI;
import com.myapp.model.Point;
import com.myapp.model.Route;
import com.myapp.model.TransportMode;
import com.myapp.service.Service;
import com.myapp.utils.RouteExporter;
import com.sothawo.mapjfx.Configuration;
import com.sothawo.mapjfx.Coordinate;
import com.sothawo.mapjfx.CoordinateLine;
import com.sothawo.mapjfx.Extent;
import com.sothawo.mapjfx.MapLabel;
import com.sothawo.mapjfx.MapView;
import com.sothawo.mapjfx.Marker;
import com.sothawo.mapjfx.Projection;
import com.sothawo.mapjfx.event.MapViewEvent;

import javafx.animation.PauseTransition;
import javafx.application.Application;
import javafx.application.Platform;
import javafx.geometry.Insets;
import javafx.geometry.Pos;
import javafx.geometry.Side;
import javafx.scene.Scene;
import javafx.scene.control.Alert;
import javafx.scene.control.Button;
import javafx.scene.control.ComboBox;
import javafx.scene.control.ContextMenu;
import javafx.scene.control.Label;
import javafx.scene.control.ListView;
import javafx.scene.control.MenuItem;
import javafx.scene.control.ScrollPane;
import javafx.scene.control.Separator;
import javafx.scene.control.TextField;
import javafx.scene.control.ToggleButton;
import javafx.scene.control.ToggleGroup;
import javafx.scene.layout.HBox;
import javafx.scene.layout.Priority;
import javafx.scene.layout.StackPane;
import javafx.scene.layout.VBox;
import javafx.scene.paint.Color;
import javafx.stage.FileChooser;
import javafx.stage.Stage;

/**
 * Interface gr√°fica (View) principal da aplica√ß√£o de planeamento de rotas.
 *
 * Papel na arquitetura MVC:
 * - View (UI): apresenta mapa interativo, formul√°rios e controlos ao
 * utilizador.
 * - Consome Service (Controller) para obter rotas, POIs, geocodifica√ß√£o e
 * eleva√ß√£o.
 * - Renderiza modelos (Route, Point, POI) no mapa; n√£o cont√©m l√≥gica de
 * neg√≥cio.
 *
 * Utiliza JavaFX e mapjfx para renderiza√ß√£o de mapas e marcadores.
 */
<span class="nc" id="L62">public class MapViewer extends Application {</span>

    // UI Layout constants
    private static final int SIDEBAR_WIDTH = 360;
    private static final int SIDEBAR_SPACING = 20;
    private static final int SIDEBAR_PADDING = 20;
    private static final int SIDEBAR_TRANSLATE_OFFSET = 20;
    private static final int SIDEBAR_SCROLL_PADDING = 10;
    private static final int WINDOW_WIDTH = 1350;
    private static final int WINDOW_HEIGHT = 800;
    private static final int POI_LIST_PREF_HEIGHT = 150;
    private static final int POI_LIST_MAX_HEIGHT = 200;
    private static final int WAYPOINT_ROW_SPACING = 10;
    private static final int ELEVATION_DIALOG_SPACING = 15;

    // Map constants
    private static final double DEFAULT_MAP_CENTER_LAT = 38.7223;
    private static final double DEFAULT_MAP_CENTER_LON = -9.1393;
    private static final int DEFAULT_MAP_ZOOM = 10;
    private static final int LOCATION_ZOOM = 14;
    private static final int POI_ZOOM = 15;

    // Time conversion
    private static final long SECONDS_PER_MINUTE = 60L;

    // Map elements
<span class="nc" id="L88">    private final MapView mapView = new MapView();</span>
<span class="nc" id="L89">    private Marker originMarker = null;</span>
<span class="nc" id="L90">    private CoordinateLine currentRouteLine = null;</span>

<span class="nc" id="L92">    private final List&lt;Point&gt; waypointPoints = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L93">    private final List&lt;Marker&gt; waypointMarkers = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L94">    private final List&lt;Marker&gt; poiMarkers = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L95">    private final List&lt;POI&gt; currentPOIs = new ArrayList&lt;&gt;();</span>

    // UI
    private TextField origemField;
    private TextField pesquisaField;
<span class="nc" id="L100">    private final VBox waypointListUI = new VBox(8);</span>
<span class="nc" id="L101">    private final VBox poiListUI = new VBox(5);</span>

<span class="nc" id="L103">    private final Label routeSummaryLabel = new Label(&quot;Defina origem e pontos de paragem...&quot;);</span>
<span class="nc" id="L104">    private final Label poiSummaryLabel = new Label(&quot;Pontos de Interesse: 0&quot;);</span>

<span class="nc" id="L106">    private final ComboBox&lt;String&gt; poiFilterBox = new ComboBox&lt;&gt;();</span>

<span class="nc" id="L108">    private Point lastSearchPoint = null;</span>
<span class="nc" id="L109">    private Route lastRoute = null;</span>

<span class="nc" id="L111">    private TransportMode selectedMode = TransportMode.CAR;</span>

<span class="nc" id="L113">    private final Service service = new Service();</span>
<span class="nc" id="L114">    private final ContextMenu suggestionsMenu = new ContextMenu();</span>

<span class="nc" id="L116">    private final com.myapp.utils.HistoryManager historyManager = new com.myapp.utils.HistoryManager();</span>

    @Override
    public void start(Stage stage) {
<span class="nc" id="L120">        stage.setTitle(&quot;Planeador de Rotas&quot;);</span>

        // Sidebar
<span class="nc" id="L123">        VBox sidebar = buildSidebarUI();</span>
<span class="nc" id="L124">        sidebar.getStyleClass().add(&quot;sidebar&quot;);</span>

        // Wrap sidebar in ScrollPane
<span class="nc" id="L127">        ScrollPane sidebarScroll = new ScrollPane(sidebar);</span>
<span class="nc" id="L128">        sidebarScroll.getStyleClass().add(&quot;sidebar-scroll&quot;);</span>
<span class="nc" id="L129">        sidebarScroll.setFitToWidth(true);</span>
<span class="nc" id="L130">        sidebarScroll.setHbarPolicy(ScrollPane.ScrollBarPolicy.NEVER);</span>
<span class="nc" id="L131">        sidebarScroll.setVbarPolicy(ScrollPane.ScrollBarPolicy.AS_NEEDED);</span>
<span class="nc" id="L132">        sidebarScroll.setMaxWidth(SIDEBAR_WIDTH);</span>
<span class="nc" id="L133">        sidebarScroll.setPadding(new Insets(SIDEBAR_SCROLL_PADDING));</span>
<span class="nc" id="L134">        sidebarScroll.setTranslateX(SIDEBAR_TRANSLATE_OFFSET);</span>
<span class="nc" id="L135">        sidebarScroll.setTranslateY(SIDEBAR_TRANSLATE_OFFSET);</span>
<span class="nc" id="L136">        sidebarScroll.setPickOnBounds(false); // Allow clicks through transparent areas</span>

        // Map container
<span class="nc" id="L139">        StackPane mapWrapper = new StackPane(mapView);</span>
<span class="nc" id="L140">        mapWrapper.setStyle(&quot;-fx-background-color: #ddd;&quot;);</span>

        // Init Map
<span class="nc" id="L143">        initMap();</span>

        // Root Layout (Floating Sidebar)
<span class="nc" id="L146">        StackPane root = new StackPane();</span>
<span class="nc" id="L147">        StackPane.setAlignment(sidebarScroll, Pos.TOP_LEFT);</span>
<span class="nc" id="L148">        root.getChildren().addAll(mapWrapper, sidebarScroll);</span>

<span class="nc" id="L150">        Scene scene = new Scene(root, WINDOW_WIDTH, WINDOW_HEIGHT);</span>
<span class="nc" id="L151">        scene.getStylesheets().add(getClass().getResource(&quot;/mapstyle.css&quot;).toExternalForm());</span>
<span class="nc" id="L152">        stage.setScene(scene);</span>
<span class="nc" id="L153">        stage.show();</span>
<span class="nc" id="L154">    }</span>

    private VBox buildSidebarUI() {
<span class="nc" id="L157">        VBox sidebar = new VBox(SIDEBAR_SPACING);</span>
<span class="nc" id="L158">        sidebar.setPadding(new Insets(SIDEBAR_PADDING));</span>
<span class="nc" id="L159">        sidebar.setPrefWidth(SIDEBAR_WIDTH);</span>

        // Origin Point
<span class="nc" id="L162">        Label lblOrigem = new Label(&quot;üìç Origem&quot;);</span>
<span class="nc" id="L163">        lblOrigem.setUnderline(true);</span>
<span class="nc" id="L164">        lblOrigem.setStyle(&quot;-fx-font-weight: bold&quot;);</span>
<span class="nc" id="L165">        origemField = new TextField();</span>
<span class="nc" id="L166">        origemField.setPromptText(&quot;Introduzir localiza√ß√£o...&quot;);</span>
<span class="nc" id="L167">        Button btnSetOrigem = new Button(&quot;üìç Definir Origem&quot;);</span>
<span class="nc" id="L168">        btnSetOrigem.getStyleClass().add(&quot;btn-secondary&quot;);</span>
<span class="nc" id="L169">        btnSetOrigem.setMaxWidth(Double.MAX_VALUE);</span>
<span class="nc" id="L170">        btnSetOrigem.setOnAction(e -&gt; handleSetOrigem());</span>

        // Waypoint List
<span class="nc" id="L173">        Label lblStops = new Label(&quot;üõë Paragens&quot;);</span>
<span class="nc" id="L174">        lblStops.setStyle(&quot;-fx-font-weight: bold&quot;);</span>
<span class="nc" id="L175">        lblStops.setUnderline(true);</span>
<span class="nc" id="L176">        Button btnClearStops = new Button(&quot;üîÑ Limpar Paragens&quot;);</span>
<span class="nc" id="L177">        btnClearStops.getStyleClass().add(&quot;btn-danger-outline&quot;);</span>
<span class="nc" id="L178">        btnClearStops.setMaxWidth(Double.MAX_VALUE);</span>
<span class="nc" id="L179">        btnClearStops.setOnAction(e -&gt; clearWaypoints());</span>

<span class="nc" id="L181">        waypointListUI.setPadding(new Insets(5));</span>

        // Search
<span class="nc" id="L184">        Label lblSearch = new Label(&quot;üîç Pesquisa&quot;);</span>
<span class="nc" id="L185">        pesquisaField = new TextField();</span>
<span class="nc" id="L186">        pesquisaField.setPromptText(&quot;Pesquisar local...&quot;);</span>
<span class="nc" id="L187">        Button btnPesquisar = new Button(&quot;üîç Pesquisar&quot;);</span>
<span class="nc" id="L188">        btnPesquisar.getStyleClass().add(&quot;btn-secondary&quot;);</span>
<span class="nc" id="L189">        btnPesquisar.setMaxWidth(Double.MAX_VALUE);</span>
<span class="nc" id="L190">        btnPesquisar.setOnAction(e -&gt; handlePesquisar());</span>

<span class="nc" id="L192">        Button btnAddSearchAsStop = new Button(&quot;‚ûï Adicionar como Paragem&quot;);</span>
<span class="nc" id="L193">        btnAddSearchAsStop.getStyleClass().add(&quot;btn-secondary-outline&quot;);</span>
<span class="nc" id="L194">        btnAddSearchAsStop.setMaxWidth(Double.MAX_VALUE);</span>
<span class="nc" id="L195">        btnAddSearchAsStop.setOnAction(e -&gt; addLastSearchAsWaypoint());</span>

<span class="nc" id="L197">        setupAutocomplete();</span>

        // Mode
<span class="nc" id="L200">        Label lblMode = new Label(&quot;Modo de Transporte&quot;);</span>
<span class="nc" id="L201">        lblMode.setUnderline(true);</span>
<span class="nc" id="L202">        lblMode.setStyle(&quot;-fx-font-weight: bold&quot;);</span>

<span class="nc" id="L204">        ToggleGroup modeGroup = new ToggleGroup();</span>

<span class="nc" id="L206">        ToggleButton btnCar = new ToggleButton(&quot;üöó Carro&quot;);</span>
<span class="nc" id="L207">        btnCar.setToggleGroup(modeGroup);</span>
<span class="nc" id="L208">        btnCar.setSelected(true);</span>
<span class="nc" id="L209">        btnCar.setMaxWidth(Double.MAX_VALUE);</span>
<span class="nc" id="L210">        btnCar.setUserData(TransportMode.CAR);</span>

<span class="nc" id="L212">        ToggleButton btnBike = new ToggleButton(&quot;üö≤ Bicicleta&quot;);</span>
<span class="nc" id="L213">        btnBike.setToggleGroup(modeGroup);</span>
<span class="nc" id="L214">        btnBike.setMaxWidth(Double.MAX_VALUE);</span>
<span class="nc" id="L215">        btnBike.setUserData(TransportMode.BIKE);</span>

<span class="nc" id="L217">        ToggleButton btnFoot = new ToggleButton(&quot;üö∂ A P√©&quot;);</span>
<span class="nc" id="L218">        btnFoot.setToggleGroup(modeGroup);</span>
<span class="nc" id="L219">        btnFoot.setMaxWidth(Double.MAX_VALUE);</span>
<span class="nc" id="L220">        btnFoot.setUserData(TransportMode.FOOT);</span>

<span class="nc" id="L222">        modeGroup.selectedToggleProperty().addListener((obs, oldToggle, newToggle) -&gt; {</span>
<span class="nc bnc" id="L223" title="All 2 branches missed.">            if (newToggle != null) {</span>
<span class="nc" id="L224">                selectedMode = (TransportMode) newToggle.getUserData();</span>
            }
<span class="nc" id="L226">        });</span>

<span class="nc" id="L228">        HBox modeButtons = new HBox(8);</span>
<span class="nc" id="L229">        HBox.setHgrow(btnCar, Priority.ALWAYS);</span>
<span class="nc" id="L230">        HBox.setHgrow(btnBike, Priority.ALWAYS);</span>
<span class="nc" id="L231">        HBox.setHgrow(btnFoot, Priority.ALWAYS);</span>
<span class="nc" id="L232">        modeButtons.getChildren().addAll(btnCar, btnBike, btnFoot);</span>

<span class="nc" id="L234">        Button btnCalcular = new Button(&quot;üöÄ Calcular Rota&quot;);</span>
<span class="nc" id="L235">        btnCalcular.getStyleClass().add(&quot;btn-primary&quot;);</span>
<span class="nc" id="L236">        btnCalcular.setMaxWidth(Double.MAX_VALUE);</span>
<span class="nc" id="L237">        btnCalcular.setOnAction(e -&gt; calculateRoute());</span>

        // Route Summary
<span class="nc" id="L240">        Label lblResumo = new Label(&quot;üìä Resumo da Rota&quot;);</span>
<span class="nc" id="L241">        lblResumo.setUnderline(true);</span>
<span class="nc" id="L242">        lblResumo.setStyle(&quot;-fx-font-weight: bold&quot;);</span>

        // POI Filter
<span class="nc" id="L245">        Label lblPOI = new Label(&quot;üìç Tipo de Ponto de Interesse&quot;);</span>
<span class="nc" id="L246">        lblPOI.setUnderline(true);</span>
<span class="nc" id="L247">        lblPOI.setStyle(&quot;-fx-font-weight: bold&quot;);</span>
<span class="nc" id="L248">        poiFilterBox.getItems().addAll(</span>
                &quot;Nenhum&quot;, &quot;Restaurante&quot;, &quot;Caf√©&quot;, &quot;Fast Food&quot;, &quot;Bar&quot;, &quot;Sanit√°rios&quot;,
                &quot;ATM&quot;, &quot;Combust√≠vel&quot;, &quot;Farm√°cia&quot;, &quot;Hospital&quot;, &quot;Estacionamento&quot;, &quot;Banco&quot;,
                &quot;Supermercado&quot;, &quot;Padaria&quot;, &quot;Shopping&quot;, &quot;Loja de Conveni√™ncia&quot;,
                &quot;Hotel&quot;, &quot;Museu&quot;, &quot;Atra√ß√£o Tur√≠stica&quot;);
<span class="nc" id="L253">        poiFilterBox.setValue(&quot;Nenhum&quot;);</span>

<span class="nc" id="L255">        Button btnSearchPOIs = new Button(&quot;üîé Pesquisar Pontos de Interesse&quot;);</span>
<span class="nc" id="L256">        btnSearchPOIs.getStyleClass().add(&quot;btn-secondary-outline&quot;);</span>
<span class="nc" id="L257">        btnSearchPOIs.setMaxWidth(Double.MAX_VALUE);</span>
<span class="nc" id="L258">        btnSearchPOIs.setOnAction(e -&gt; handleSearchPois());</span>

        // POI List
<span class="nc" id="L261">        ScrollPane poiListScroll = new ScrollPane(poiListUI);</span>
<span class="nc" id="L262">        poiListScroll.setFitToWidth(true);</span>
<span class="nc" id="L263">        poiListScroll.setPrefHeight(POI_LIST_PREF_HEIGHT);</span>
<span class="nc" id="L264">        poiListScroll.setMaxHeight(POI_LIST_MAX_HEIGHT);</span>
<span class="nc" id="L265">        poiListUI.setPadding(new Insets(5));</span>
<span class="nc" id="L266">        poiListUI.getStyleClass().add(&quot;poi-list-container&quot;);</span>

        // Elevation
<span class="nc" id="L269">        Label lblElevation = new Label(&quot;üìà Perfil Altim√©trico&quot;);</span>
<span class="nc" id="L270">        lblElevation.setUnderline(true);</span>
<span class="nc" id="L271">        lblElevation.setStyle(&quot;-fx-font-weight: bold&quot;);</span>
<span class="nc" id="L272">        Button btnElevation = new Button(&quot;üìä Mostrar Eleva√ß√£o&quot;);</span>
<span class="nc" id="L273">        btnElevation.getStyleClass().add(&quot;btn-info-outline&quot;);</span>
<span class="nc" id="L274">        btnElevation.setMaxWidth(Double.MAX_VALUE);</span>
<span class="nc" id="L275">        btnElevation.setOnAction(e -&gt; handleShowElevation());</span>

        // History
<span class="nc" id="L278">        Button btnHistory = new Button(&quot;üìú Ver Hist√≥rico&quot;);</span>
<span class="nc" id="L279">        btnHistory.getStyleClass().add(&quot;btn-info-outline&quot;); // Ou o teu estilo preferido</span>
<span class="nc" id="L280">        btnHistory.setMaxWidth(Double.MAX_VALUE);</span>
<span class="nc" id="L281">        btnHistory.setOnAction(e -&gt; showHistoryDialog());</span>

        // Export
<span class="nc" id="L284">        Label lblExport = new Label(&quot;üì§ Exportar&quot;);</span>
<span class="nc" id="L285">        lblExport.setUnderline(true);</span>
<span class="nc" id="L286">        lblExport.setStyle(&quot;-fx-font-weight: bold&quot;);</span>
<span class="nc" id="L287">        HBox exportButtons = new HBox(8);</span>
<span class="nc" id="L288">        Button btnJson = new Button(&quot;üìÑ JSON&quot;);</span>
<span class="nc" id="L289">        btnJson.getStyleClass().add(&quot;btn-export&quot;);</span>
<span class="nc" id="L290">        btnJson.setMaxWidth(Double.MAX_VALUE);</span>
<span class="nc" id="L291">        btnJson.setOnAction(e -&gt; handleExportJson());</span>

<span class="nc" id="L293">        Button btnGpx = new Button(&quot;üó∫Ô∏è GPX&quot;);</span>
<span class="nc" id="L294">        btnGpx.getStyleClass().add(&quot;btn-export&quot;);</span>
<span class="nc" id="L295">        btnGpx.setMaxWidth(Double.MAX_VALUE);</span>
<span class="nc" id="L296">        btnGpx.setOnAction(e -&gt; handleExportGpx());</span>

<span class="nc" id="L298">        HBox.setHgrow(btnJson, Priority.ALWAYS);</span>
<span class="nc" id="L299">        HBox.setHgrow(btnGpx, Priority.ALWAYS);</span>
<span class="nc" id="L300">        exportButtons.getChildren().addAll(btnJson, btnGpx);</span>

        // Reset
<span class="nc" id="L303">        Button btnReset = new Button(&quot;üîÑ Limpar Tudo&quot;);</span>
<span class="nc" id="L304">        btnReset.getStyleClass().add(&quot;btn-danger&quot;);</span>
<span class="nc" id="L305">        btnReset.setMaxWidth(Double.MAX_VALUE);</span>
<span class="nc" id="L306">        btnReset.setOnAction(e -&gt; resetAll());</span>

<span class="nc" id="L308">        sidebar.getChildren().addAll(</span>
                lblOrigem, origemField, btnSetOrigem,
                new Separator(),
                lblStops, waypointListUI, btnClearStops,
                new Separator(),
                lblSearch, pesquisaField, btnPesquisar, btnAddSearchAsStop,
                new Separator(),
                lblMode, modeButtons, btnCalcular,
                new Separator(),
                lblResumo, routeSummaryLabel,
                new Separator(),
                lblPOI, poiFilterBox, btnSearchPOIs, poiSummaryLabel,
                poiListScroll,
                new Separator(),
                lblElevation, btnElevation,
                new Separator(),
                btnHistory,
                new Separator(),
                lblExport, exportButtons,
                new Separator(),
                btnReset);

<span class="nc" id="L330">        return sidebar;</span>
    }

    // Inicializa o mapa e define eventos iniciais.

    private void initMap() {
<span class="nc" id="L336">        mapView.initialize(Configuration.builder()</span>
<span class="nc" id="L337">                .projection(Projection.WEB_MERCATOR)</span>
<span class="nc" id="L338">                .showZoomControls(true)</span>
<span class="nc" id="L339">                .build());</span>

<span class="nc" id="L341">        mapView.initializedProperty().addListener((obs, old, initialized) -&gt; {</span>
<span class="nc bnc" id="L342" title="All 2 branches missed.">            if (initialized) {</span>
<span class="nc" id="L343">                mapView.setCenter(new Coordinate(DEFAULT_MAP_CENTER_LAT, DEFAULT_MAP_CENTER_LON));</span>
<span class="nc" id="L344">                mapView.setZoom(DEFAULT_MAP_ZOOM);</span>

<span class="nc" id="L346">                mapView.addEventHandler(MapViewEvent.MAP_CLICKED, event -&gt; {</span>
<span class="nc" id="L347">                    Coordinate c = event.getCoordinate();</span>
<span class="nc bnc" id="L348" title="All 2 branches missed.">                    if (originMarker == null)</span>
<span class="nc" id="L349">                        setOrigin(c);</span>
                    else
<span class="nc" id="L351">                        addWaypoint(c, null);</span>
<span class="nc" id="L352">                });</span>
            }
<span class="nc" id="L354">        });</span>
<span class="nc" id="L355">    }</span>

    /**
     * Define a origem no mapa e atualiza o marcador.
     * 
     * @param c
     */
    private void setOrigin(Coordinate c) {
<span class="nc bnc" id="L363" title="All 2 branches missed.">        if (originMarker != null)</span>
<span class="nc" id="L364">            mapView.removeMarker(originMarker);</span>

<span class="nc" id="L366">        originMarker = Marker.createProvided(Marker.Provided.RED)</span>
<span class="nc" id="L367">                .setPosition(c)</span>
<span class="nc" id="L368">                .setVisible(true);</span>

<span class="nc" id="L370">        mapView.addMarker(originMarker);</span>
<span class="nc" id="L371">        routeSummaryLabel.setText(&quot;Origem definida.&quot;);</span>
<span class="nc" id="L372">    }</span>

    private void handleSetOrigem() {
<span class="nc" id="L375">        String input = origemField.getText().trim();</span>
<span class="nc bnc" id="L376" title="All 2 branches missed.">        if (input.isEmpty())</span>
<span class="nc" id="L377">            return;</span>

<span class="nc" id="L379">        new Thread(() -&gt; {</span>
<span class="nc" id="L380">            Point result = service.getGeocodeFromLocationString(input);</span>
<span class="nc bnc" id="L381" title="All 2 branches missed.">            if (result == null)</span>
<span class="nc" id="L382">                return;</span>

<span class="nc" id="L384">            Platform.runLater(() -&gt; {</span>
<span class="nc" id="L385">                Coordinate c = new Coordinate(result.getLatitude(), result.getLongitude());</span>
<span class="nc" id="L386">                setOrigin(c);</span>
<span class="nc" id="L387">                origemField.setText(result.getName());</span>
<span class="nc" id="L388">                mapView.setCenter(c);</span>
<span class="nc" id="L389">                mapView.setZoom(LOCATION_ZOOM);</span>
<span class="nc" id="L390">            });</span>
<span class="nc" id="L391">        }).start();</span>
<span class="nc" id="L392">    }</span>

    /**
     * Adiciona um ponto de paragem (waypoint) no mapa.
     * 
     * @param c
     */
    private void addWaypoint(Coordinate c, String name) {
<span class="nc" id="L400">        Point p = new Point(c.getLatitude(), c.getLongitude(), name);</span>

<span class="nc" id="L402">        waypointPoints.add(p);</span>

<span class="nc" id="L404">        Marker m = Marker.createProvided(Marker.Provided.BLUE)</span>
<span class="nc" id="L405">                .setPosition(c)</span>
<span class="nc" id="L406">                .setVisible(true);</span>

<span class="nc" id="L408">        waypointMarkers.add(m);</span>
<span class="nc" id="L409">        mapView.addMarker(m);</span>

<span class="nc" id="L411">        updateWaypointUI();</span>
<span class="nc" id="L412">    }</span>

    // Atualiza a lista de paragens (waypoints) na UI.

    private void updateWaypointUI() {
<span class="nc" id="L417">        waypointListUI.getChildren().clear();</span>

<span class="nc bnc" id="L419" title="All 2 branches missed.">        for (int i = 0; i &lt; waypointPoints.size(); i++) {</span>
<span class="nc" id="L420">            int index = i;</span>

<span class="nc" id="L422">            HBox row = new HBox(WAYPOINT_ROW_SPACING);</span>
<span class="nc" id="L423">            row.setAlignment(Pos.CENTER_LEFT);</span>

<span class="nc" id="L425">            Label label = new Label((i + 1) + &quot; - Paragem&quot;);</span>
<span class="nc" id="L426">            Button removeBtn = new Button(&quot;‚úñ Remover&quot;);</span>
<span class="nc" id="L427">            removeBtn.getStyleClass().add(&quot;btn-remove-small&quot;);</span>

<span class="nc" id="L429">            removeBtn.setOnAction(e -&gt; {</span>
<span class="nc" id="L430">                removeWaypoint(index);</span>
<span class="nc" id="L431">                calculateRoute();</span>
<span class="nc" id="L432">            });</span>

<span class="nc" id="L434">            row.getChildren().addAll(label, removeBtn);</span>
<span class="nc" id="L435">            waypointListUI.getChildren().add(row);</span>
        }
<span class="nc" id="L437">    }</span>

    /**
     * Remove um ponto de paragem (waypoint) pelo √≠ndice.
     * 
     * @param index
     */
    private void removeWaypoint(int index) {
<span class="nc" id="L445">        mapView.removeMarker(waypointMarkers.get(index));</span>
<span class="nc" id="L446">        waypointMarkers.remove(index);</span>
<span class="nc" id="L447">        waypointPoints.remove(index);</span>
<span class="nc" id="L448">        updateWaypointUI();</span>
<span class="nc" id="L449">    }</span>

    private void clearWaypoints() {
<span class="nc" id="L452">        waypointMarkers.forEach(mapView::removeMarker);</span>
<span class="nc" id="L453">        waypointMarkers.clear();</span>
<span class="nc" id="L454">        waypointPoints.clear();</span>
<span class="nc" id="L455">        updateWaypointUI();</span>
<span class="nc" id="L456">    }</span>

    private void addLastSearchAsWaypoint() {
<span class="nc bnc" id="L459" title="All 2 branches missed.">        if (lastSearchPoint == null)</span>
<span class="nc" id="L460">            return;</span>
<span class="nc" id="L461">        Coordinate c = new Coordinate(lastSearchPoint.getLatitude(), lastSearchPoint.getLongitude());</span>
<span class="nc" id="L462">        addWaypoint(c, lastSearchPoint.getName());</span>
<span class="nc" id="L463">    }</span>

    // Calcula a rota com a origem e paragens definidas.~

    private void calculateRoute() {
<span class="nc bnc" id="L468" title="All 2 branches missed.">        if (originMarker == null) {</span>
<span class="nc" id="L469">            routeSummaryLabel.setText(&quot;Defina uma origem.&quot;);</span>
<span class="nc" id="L470">            return;</span>
        }

<span class="nc bnc" id="L473" title="All 2 branches missed.">        if (currentRouteLine != null)</span>
<span class="nc" id="L474">            mapView.removeCoordinateLine(currentRouteLine);</span>

<span class="nc" id="L476">        String originName = origemField.getText();</span>

<span class="nc bnc" id="L478" title="All 4 branches missed.">        if (originName != null &amp;&amp; originName.isBlank())</span>
<span class="nc" id="L479">            originName = null;</span>

<span class="nc" id="L481">        Point origin = new Point(</span>
<span class="nc" id="L482">                originMarker.getPosition().getLatitude(),</span>
<span class="nc" id="L483">                originMarker.getPosition().getLongitude(),</span>
                originName);

<span class="nc" id="L486">        Route route = service.getRouteWithWaypoints(origin, waypointPoints, selectedMode);</span>

<span class="nc bnc" id="L488" title="All 4 branches missed.">        if (route == null || route.getRoutePoints().isEmpty()) {</span>
<span class="nc" id="L489">            routeSummaryLabel.setText(&quot;Erro ao calcular rota.&quot;);</span>
<span class="nc" id="L490">            return;</span>
        }

<span class="nc" id="L493">        List&lt;Coordinate&gt; coords = route.getRoutePoints().stream()</span>
<span class="nc" id="L494">                .map(p -&gt; new Coordinate(p.getLatitude(), p.getLongitude()))</span>
<span class="nc" id="L495">                .toList();</span>

<span class="nc" id="L497">        currentRouteLine = new CoordinateLine(coords)</span>
<span class="nc" id="L498">                .setColor(Color.BLUE)</span>
<span class="nc" id="L499">                .setVisible(true);</span>

<span class="nc" id="L501">        mapView.addCoordinateLine(currentRouteLine);</span>

        try {
            // Se a rota for muito curta (&lt; 10 metros) ou tiver apenas 1 ponto √∫nico
<span class="nc bnc" id="L505" title="All 4 branches missed.">            if (route.getDistanceKm() &lt; 0.01 || coords.size() &lt;= 1) {</span>

                // √â o mesmo local: Centra apenas e d√° zoom manual seguro
<span class="nc" id="L508">                mapView.setCenter(coords.get(0));</span>
<span class="nc" id="L509">                mapView.setZoom(17);</span>
            } else {

                // Rota normal: Ajusta o zoom automaticamente
<span class="nc" id="L513">                mapView.setExtent(Extent.forCoordinates(coords));</span>
            }
<span class="nc" id="L515">        } catch (Exception ex) {</span>
            // Fallback de seguran√ßa m√°xima: se o zoom falhar, n√£o deixa o ecr√£ branco
<span class="nc" id="L517">            System.err.println(&quot;Erro cr√≠tico ao ajustar zoom: &quot; + ex.getMessage());</span>
<span class="nc bnc" id="L518" title="All 2 branches missed.">            if (!coords.isEmpty()) {</span>
<span class="nc" id="L519">                mapView.setCenter(coords.get(0));</span>
<span class="nc" id="L520">                mapView.setZoom(10);</span>
            }
<span class="nc" id="L522">        }</span>

<span class="nc" id="L524">        lastRoute = route;</span>

<span class="nc bnc" id="L526" title="All 2 branches missed.">        if (!waypointPoints.isEmpty()) {</span>
<span class="nc" id="L527">            Point destination = waypointPoints.get(waypointPoints.size() - 1);</span>
<span class="nc" id="L528">            List&lt;Point&gt; savedWaypoints = new ArrayList&lt;&gt;(waypointPoints);</span>
<span class="nc" id="L529">            com.myapp.model.HistoryEntry entry = new com.myapp.model.HistoryEntry(</span>
                    origin, destination, savedWaypoints, selectedMode);

<span class="nc" id="L532">            historyManager.addEntry(entry);</span>
<span class="nc" id="L533">            System.out.println(&quot;Rota adicionada ao hist√≥rico.&quot;);</span>
        }

<span class="nc" id="L536">        routeSummaryLabel.setText(</span>
<span class="nc" id="L537">                String.format(&quot;Dist√¢ncia: %.2f km | Tempo: %d min | Paragens: %d&quot;,</span>
<span class="nc" id="L538">                        route.getDistanceKm(),</span>
<span class="nc" id="L539">                        route.getDurationSec() / SECONDS_PER_MINUTE,</span>
<span class="nc" id="L540">                        waypointPoints.size()));</span>
<span class="nc" id="L541">    }</span>

    // Pesquisa a localiza√ß√£o introduzida no campo de pesquisa e centra o mapa.

    private void handlePesquisar() {
<span class="nc" id="L546">        String query = pesquisaField.getText().trim();</span>
<span class="nc bnc" id="L547" title="All 2 branches missed.">        if (query.isEmpty())</span>
<span class="nc" id="L548">            return;</span>

<span class="nc" id="L550">        new Thread(() -&gt; {</span>
<span class="nc" id="L551">            Point result = service.getGeocodeFromLocationString(query);</span>
<span class="nc bnc" id="L552" title="All 2 branches missed.">            if (result == null)</span>
<span class="nc" id="L553">                return;</span>

<span class="nc" id="L555">            lastSearchPoint = result;</span>

<span class="nc" id="L557">            Platform.runLater(() -&gt; {</span>
<span class="nc" id="L558">                Coordinate c = new Coordinate(result.getLatitude(), result.getLongitude());</span>
<span class="nc" id="L559">                mapView.setCenter(c);</span>
<span class="nc" id="L560">                mapView.setZoom(LOCATION_ZOOM);</span>
<span class="nc" id="L561">            });</span>
<span class="nc" id="L562">        }).start();</span>
<span class="nc" id="L563">    }</span>

    // Configura o sistema de autocompletar para os campos de texto.

    private void setupAutocomplete() {
<span class="nc" id="L568">        setupFieldAutocomplete(pesquisaField);</span>
<span class="nc" id="L569">        setupFieldAutocomplete(origemField);</span>
<span class="nc" id="L570">    }</span>

    /**
     * Configura o autocompletar para um campo de texto espec√≠fico.
     * 
     * @param field
     */
    private void setupFieldAutocomplete(TextField field) {
<span class="nc" id="L578">        PauseTransition pause = new PauseTransition(javafx.util.Duration.millis(400));</span>

<span class="nc" id="L580">        field.textProperty().addListener((obs, oldText, newText) -&gt; {</span>
<span class="nc bnc" id="L581" title="All 4 branches missed.">            if (newText == null || newText.isBlank()) {</span>
<span class="nc" id="L582">                suggestionsMenu.hide();</span>
<span class="nc" id="L583">                return;</span>
            }

<span class="nc" id="L586">            pause.setOnFinished(event -&gt; {</span>
<span class="nc" id="L587">                String queryAtRequestTime = field.getText(); // Pode ser null se mudou entretanto</span>

                // Outra verifica√ß√£o de seguran√ßa
<span class="nc bnc" id="L590" title="All 4 branches missed.">                if (queryAtRequestTime == null || queryAtRequestTime.trim().length() &lt; 3)</span>
<span class="nc" id="L591">                    return;</span>

<span class="nc" id="L593">                final String queryFinal = queryAtRequestTime.trim();</span>

<span class="nc" id="L595">                new Thread(() -&gt; {</span>
                    try {
<span class="nc" id="L597">                        List&lt;Point&gt; results = service.searchLocations(queryFinal);</span>

<span class="nc" id="L599">                        Platform.runLater(() -&gt; {</span>
                            // Verificar se o texto mudou ou ficou null entretanto
<span class="nc" id="L601">                            String currentText = field.getText();</span>
<span class="nc bnc" id="L602" title="All 4 branches missed.">                            if (currentText == null || !currentText.trim().equals(queryFinal)) {</span>
<span class="nc" id="L603">                                return;</span>
                            }

<span class="nc" id="L606">                            suggestionsMenu.getItems().clear();</span>

<span class="nc bnc" id="L608" title="All 2 branches missed.">                            for (Point p : results) {</span>
<span class="nc" id="L609">                                MenuItem item = new MenuItem(p.getName());</span>
<span class="nc" id="L610">                                item.setOnAction(e -&gt; {</span>
<span class="nc" id="L611">                                    field.setText(p.getName());</span>
<span class="nc" id="L612">                                    lastSearchPoint = p;</span>
<span class="nc" id="L613">                                    suggestionsMenu.hide();</span>
<span class="nc" id="L614">                                });</span>
<span class="nc" id="L615">                                suggestionsMenu.getItems().add(item);</span>
<span class="nc" id="L616">                            }</span>

<span class="nc bnc" id="L618" title="All 2 branches missed.">                            if (!results.isEmpty()) {</span>
<span class="nc bnc" id="L619" title="All 2 branches missed.">                                if (field.isFocused()) {</span>
<span class="nc" id="L620">                                    suggestionsMenu.show(field, Side.BOTTOM, 0, 0);</span>
                                }
                            } else {
<span class="nc" id="L623">                                suggestionsMenu.hide();</span>
                            }
<span class="nc" id="L625">                        });</span>

<span class="nc" id="L627">                    } catch (Exception e) {</span>
<span class="nc" id="L628">                        e.printStackTrace();</span>
<span class="nc" id="L629">                    }</span>
<span class="nc" id="L630">                }).start();</span>
<span class="nc" id="L631">            });</span>

<span class="nc" id="L633">            pause.playFromStart();</span>
<span class="nc" id="L634">        });</span>

<span class="nc" id="L636">        field.focusedProperty().addListener((obs, oldVal, newVal) -&gt; {</span>
<span class="nc bnc" id="L637" title="All 2 branches missed.">            if (!newVal) {</span>
<span class="nc" id="L638">                suggestionsMenu.hide();</span>
            }
<span class="nc" id="L640">        });</span>
<span class="nc" id="L641">    }</span>

    // Pesquisa Pontos de Interesse ao longo da rota atual.

    private void handleSearchPois() {
<span class="nc bnc" id="L646" title="All 2 branches missed.">        if (lastRoute == null) {</span>
<span class="nc" id="L647">            poiSummaryLabel.setText(&quot;Calcula a rota primeiro.&quot;);</span>
<span class="nc" id="L648">            return;</span>
        }

<span class="nc" id="L651">        String selected = poiFilterBox.getValue();</span>

<span class="nc bnc" id="L653" title="All 2 branches missed.">        if (selected.equals(&quot;Nenhum&quot;)) {</span>
<span class="nc" id="L654">            clearPOIsFromMap();</span>
<span class="nc" id="L655">            poiSummaryLabel.setText(&quot;Pontos de Interesse: 0&quot;);</span>
<span class="nc" id="L656">            return;</span>
        }

<span class="nc" id="L659">        poiSummaryLabel.setText(&quot;A procurar Pontos de Interesse...&quot;);</span>
<span class="nc" id="L660">        poiListUI.getChildren().clear();</span>

<span class="nc" id="L662">        new Thread(() -&gt; {</span>
<span class="nc" id="L663">            List&lt;POI&gt; pois = service.getPOIsAlongRoute(lastRoute, selected);</span>

<span class="nc" id="L665">            Platform.runLater(() -&gt; {</span>
<span class="nc" id="L666">                currentPOIs.clear();</span>
<span class="nc" id="L667">                currentPOIs.addAll(pois);</span>

                // Add POIs to route for export
<span class="nc bnc" id="L670" title="All 2 branches missed.">                if (lastRoute != null) {</span>
<span class="nc" id="L671">                    lastRoute.getPois().clear();</span>
<span class="nc" id="L672">                    lastRoute.getPois().addAll(pois);</span>
                }

<span class="nc" id="L675">                showPoisOnMap(pois);</span>
<span class="nc" id="L676">                updatePOIList(pois);</span>
<span class="nc" id="L677">                poiSummaryLabel.setText(&quot;Pontos de Interesse: &quot; + pois.size());</span>
<span class="nc" id="L678">            });</span>
<span class="nc" id="L679">        }).start();</span>
<span class="nc" id="L680">    }</span>

    /**
     * Mostra os Pontos de Interesse no mapa.
     * 
     * @param pois
     */
    private void showPoisOnMap(List&lt;POI&gt; pois) {
<span class="nc" id="L688">        clearPOIsFromMap();</span>

<span class="nc bnc" id="L690" title="All 2 branches missed.">        for (int i = 0; i &lt; pois.size(); i++) {</span>
<span class="nc" id="L691">            POI poi = pois.get(i);</span>
<span class="nc" id="L692">            Coordinate coord = new Coordinate(</span>
<span class="nc" id="L693">                    poi.getCoordinate().getLatitude(),</span>
<span class="nc" id="L694">                    poi.getCoordinate().getLongitude());</span>

<span class="nc" id="L696">            Marker marker = Marker.createProvided(Marker.Provided.ORANGE)</span>
<span class="nc" id="L697">                    .setPosition(coord)</span>
<span class="nc" id="L698">                    .setVisible(true);</span>

<span class="nc" id="L700">            poiMarkers.add(marker);</span>
<span class="nc" id="L701">            mapView.addMarker(marker);</span>

            // Adicionar label ao marker
<span class="nc bnc" id="L704" title="All 2 branches missed.">            marker.attachLabel(new MapLabel(poi.getName() != null ? poi.getName() : &quot;Ponto de Interesse #&quot; + (i + 1))</span>
<span class="nc" id="L705">                    .setCssClass(&quot;poi-label&quot;));</span>
        }
<span class="nc" id="L707">    }</span>

    /**
     * Atualiza a lista de Pontos de Interesse na UI.
     * 
     * @param pois
     */
    private void updatePOIList(List&lt;POI&gt; pois) {
<span class="nc" id="L715">        poiListUI.getChildren().clear();</span>

<span class="nc bnc" id="L717" title="All 2 branches missed.">        if (pois.isEmpty()) {</span>
<span class="nc" id="L718">            Label emptyLabel = new Label(&quot;Nenhum Ponto de Interesse encontrado&quot;);</span>
<span class="nc" id="L719">            emptyLabel.getStyleClass().add(&quot;poi-empty-label&quot;);</span>
<span class="nc" id="L720">            poiListUI.getChildren().add(emptyLabel);</span>
<span class="nc" id="L721">            return;</span>
        }

<span class="nc bnc" id="L724" title="All 2 branches missed.">        for (int i = 0; i &lt; pois.size(); i++) {</span>
<span class="nc" id="L725">            POI poi = pois.get(i);</span>

<span class="nc bnc" id="L727" title="All 2 branches missed.">            String name = poi.getName() != null ? poi.getName() : &quot;Sem nome&quot;;</span>
<span class="nc bnc" id="L728" title="All 2 branches missed.">            String category = poi.getCategory() != null ? poi.getCategory() : &quot;Desconhecido&quot;;</span>
<span class="nc" id="L729">            String address = String.format(&quot;%.4f, %.4f&quot;,</span>
<span class="nc" id="L730">                    poi.getCoordinate().getLatitude(),</span>
<span class="nc" id="L731">                    poi.getCoordinate().getLongitude());</span>

<span class="nc" id="L733">            Label poiLabel = new Label(&quot;‚óè &quot; + name);</span>
<span class="nc" id="L734">            poiLabel.getStyleClass().add(&quot;poi-label-text&quot;);</span>

<span class="nc" id="L736">            Label categoryLabel = new Label(&quot;   &quot; + category);</span>
<span class="nc" id="L737">            categoryLabel.getStyleClass().add(&quot;poi-category-label&quot;);</span>

<span class="nc" id="L739">            Label addressLabel = new Label(&quot;   &quot; + address);</span>
<span class="nc" id="L740">            addressLabel.getStyleClass().add(&quot;poi-category-label&quot;);</span>
<span class="nc" id="L741">            addressLabel.setStyle(&quot;-fx-font-size: 9px; -fx-text-fill: #666;&quot;);</span>

<span class="nc" id="L743">            VBox poiEntry = new VBox(2, poiLabel, categoryLabel, addressLabel);</span>
<span class="nc" id="L744">            poiEntry.setPadding(new Insets(3, 5, 3, 5));</span>
<span class="nc" id="L745">            poiEntry.getStyleClass().add(&quot;poi-entry&quot;);</span>

            // Click para centrar no mapa
<span class="nc" id="L748">            poiEntry.setOnMouseClicked(e -&gt; {</span>
<span class="nc" id="L749">                Coordinate coord = new Coordinate(</span>
<span class="nc" id="L750">                        poi.getCoordinate().getLatitude(),</span>
<span class="nc" id="L751">                        poi.getCoordinate().getLongitude());</span>
<span class="nc" id="L752">                mapView.setCenter(coord);</span>
<span class="nc" id="L753">                mapView.setZoom(POI_ZOOM);</span>
<span class="nc" id="L754">            });</span>

<span class="nc" id="L756">            poiListUI.getChildren().add(poiEntry);</span>
        }
<span class="nc" id="L758">    }</span>

    // Remove todos os Pontos de Interesse do mapa.

    private void clearPOIsFromMap() {
<span class="nc bnc" id="L763" title="All 2 branches missed.">        for (Marker m : poiMarkers)</span>
<span class="nc" id="L764">            mapView.removeMarker(m);</span>
<span class="nc" id="L765">        poiMarkers.clear();</span>
<span class="nc" id="L766">        currentPOIs.clear();</span>
<span class="nc" id="L767">        poiListUI.getChildren().clear();</span>
<span class="nc" id="L768">    }</span>

    // Exporta a rota atual para ficheiro JSON.

    private void handleExportJson() {
<span class="nc bnc" id="L773" title="All 2 branches missed.">        if (lastRoute == null)</span>
<span class="nc" id="L774">            return;</span>

<span class="nc" id="L776">        FileChooser fileChooser = new FileChooser();</span>
<span class="nc" id="L777">        fileChooser.setTitle(&quot;Guardar Rota como JSON&quot;);</span>
<span class="nc" id="L778">        fileChooser.setInitialFileName(&quot;route.json&quot;);</span>
<span class="nc" id="L779">        fileChooser.getExtensionFilters().add(</span>
                new FileChooser.ExtensionFilter(&quot;JSON files (*.json)&quot;, &quot;*.json&quot;));

<span class="nc" id="L782">        java.io.File file = fileChooser.showSaveDialog(mapView.getScene().getWindow());</span>
<span class="nc bnc" id="L783" title="All 2 branches missed.">        if (file != null) {</span>
            try {
<span class="nc" id="L785">                RouteExporter.exportToJson(lastRoute, file.getAbsolutePath());</span>
<span class="nc" id="L786">                showAlert(&quot;Exporta√ß√£o bem-sucedida&quot;, &quot;Rota guardada em: &quot; + file.getAbsolutePath());</span>
<span class="nc" id="L787">            } catch (Exception ex) {</span>
<span class="nc" id="L788">                showAlert(&quot;Erro na exporta√ß√£o&quot;, &quot;N√£o foi poss√≠vel guardar o ficheiro: &quot; + ex.getMessage());</span>
<span class="nc" id="L789">                ex.printStackTrace();</span>
<span class="nc" id="L790">            }</span>
        }
<span class="nc" id="L792">    }</span>

    // Exporta a rota atual para ficheiro GPX.

    private void handleExportGpx() {
<span class="nc bnc" id="L797" title="All 2 branches missed.">        if (lastRoute == null)</span>
<span class="nc" id="L798">            return;</span>

<span class="nc" id="L800">        FileChooser fileChooser = new FileChooser();</span>
<span class="nc" id="L801">        fileChooser.setTitle(&quot;Guardar Rota como GPX&quot;);</span>
<span class="nc" id="L802">        fileChooser.setInitialFileName(&quot;route.gpx&quot;);</span>
<span class="nc" id="L803">        fileChooser.getExtensionFilters().add(</span>
                new FileChooser.ExtensionFilter(&quot;GPX files (*.gpx)&quot;, &quot;*.gpx&quot;));

<span class="nc" id="L806">        java.io.File file = fileChooser.showSaveDialog(mapView.getScene().getWindow());</span>
<span class="nc bnc" id="L807" title="All 2 branches missed.">        if (file != null) {</span>
            try {
<span class="nc" id="L809">                RouteExporter.exportToGPX(lastRoute, file.getAbsolutePath());</span>
<span class="nc" id="L810">                showAlert(&quot;Exporta√ß√£o bem-sucedida&quot;, &quot;Rota guardada em: &quot; + file.getAbsolutePath());</span>
<span class="nc" id="L811">            } catch (Exception ex) {</span>
<span class="nc" id="L812">                showAlert(&quot;Erro na exporta√ß√£o&quot;, &quot;N√£o foi poss√≠vel guardar o ficheiro: &quot; + ex.getMessage());</span>
<span class="nc" id="L813">                ex.printStackTrace();</span>
<span class="nc" id="L814">            }</span>
        }
<span class="nc" id="L816">    }</span>

    // Mostra o perfil altim√©trico da rota atual.

    private void handleShowElevation() {
<span class="nc bnc" id="L821" title="All 2 branches missed.">        if (lastRoute == null) {</span>
<span class="nc" id="L822">            showAlert(&quot;Erro&quot;, &quot;Calcule uma rota primeiro.&quot;);</span>
<span class="nc" id="L823">            return;</span>
        }

<span class="nc" id="L826">        Alert loadingAlert = new Alert(Alert.AlertType.INFORMATION);</span>
<span class="nc" id="L827">        loadingAlert.setTitle(&quot;Perfil Altim√©trico&quot;);</span>
<span class="nc" id="L828">        loadingAlert.setHeaderText(&quot;A obter dados de eleva√ß√£o...&quot;);</span>
<span class="nc" id="L829">        loadingAlert.setContentText(&quot;Por favor aguarde...&quot;);</span>
<span class="nc" id="L830">        loadingAlert.show();</span>

<span class="nc" id="L832">        new Thread(() -&gt; {</span>
<span class="nc" id="L833">            var profile = service.getElevationProfile(lastRoute);</span>

<span class="nc" id="L835">            Platform.runLater(() -&gt; {</span>
<span class="nc" id="L836">                loadingAlert.close();</span>

<span class="nc bnc" id="L838" title="All 2 branches missed.">                if (profile == null) {</span>
<span class="nc" id="L839">                    showAlert(&quot;Erro&quot;, &quot;N√£o foi poss√≠vel obter dados de eleva√ß√£o.&quot;);</span>
<span class="nc" id="L840">                    return;</span>
                }

<span class="nc" id="L843">                showElevationChart(profile);</span>
<span class="nc" id="L844">            });</span>
<span class="nc" id="L845">        }).start();</span>
<span class="nc" id="L846">    }</span>

    /**
     * Mostra o gr√°fico do perfil altim√©trico.
     * 
     * @param profile
     */
    private void showElevationChart(com.myapp.model.ElevationProfile profile) {
<span class="nc" id="L854">        Stage chartStage = new Stage();</span>
<span class="nc" id="L855">        chartStage.setTitle(&quot;Perfil Altim√©trico da Rota&quot;);</span>

<span class="nc" id="L857">        VBox root = new VBox(ELEVATION_DIALOG_SPACING);</span>
<span class="nc" id="L858">        root.setPadding(new Insets(20));</span>

        // Estat√≠sticas
<span class="nc" id="L861">        Label stats = new Label(String.format(</span>
                &quot;Eleva√ß√£o M√°xima: %.0fm | Eleva√ß√£o M√≠nima: %.0fm | Subida Total: %.0fm | Descida Total: %.0fm&quot;,
<span class="nc" id="L863">                profile.getMaxElevation(), profile.getMinElevation(),</span>
<span class="nc" id="L864">                profile.getTotalAscent(), profile.getTotalDescent()));</span>
<span class="nc" id="L865">        stats.getStyleClass().add(&quot;elevation-stats-label&quot;);</span>

        // Canvas para desenhar gr√°fico
<span class="nc" id="L868">        javafx.scene.canvas.Canvas canvas = new javafx.scene.canvas.Canvas(800, 400);</span>
<span class="nc" id="L869">        var gc = canvas.getGraphicsContext2D();</span>

        // Fundo
<span class="nc" id="L872">        gc.setFill(javafx.scene.paint.Color.WHITE);</span>
<span class="nc" id="L873">        gc.fillRect(0, 0, 800, 400);</span>

        // Dados
<span class="nc" id="L876">        var elevations = profile.getElevations();</span>
<span class="nc" id="L877">        var distances = profile.getDistances();</span>

<span class="nc bnc" id="L879" title="All 2 branches missed.">        if (elevations.isEmpty())</span>
<span class="nc" id="L880">            return;</span>

        // Margens
<span class="nc" id="L883">        double marginLeft = 60, marginRight = 20, marginTop = 30, marginBottom = 50;</span>
<span class="nc" id="L884">        double chartWidth = 800 - marginLeft - marginRight;</span>
<span class="nc" id="L885">        double chartHeight = 400 - marginTop - marginBottom;</span>

        // Escala
<span class="nc" id="L888">        double maxDist = distances.get(distances.size() - 1);</span>
<span class="nc" id="L889">        double maxElev = profile.getMaxElevation();</span>
<span class="nc" id="L890">        double minElev = profile.getMinElevation();</span>
<span class="nc" id="L891">        double elevRange = maxElev - minElev;</span>
<span class="nc bnc" id="L892" title="All 2 branches missed.">        if (elevRange &lt; 10)</span>
<span class="nc" id="L893">            elevRange = 10; // Evitar divis√£o por zero</span>

        // Eixos
<span class="nc" id="L896">        gc.setStroke(javafx.scene.paint.Color.BLACK);</span>
<span class="nc" id="L897">        gc.setLineWidth(2);</span>
<span class="nc" id="L898">        gc.strokeLine(marginLeft, marginTop, marginLeft, marginTop + chartHeight); // Y</span>
<span class="nc" id="L899">        gc.strokeLine(marginLeft, marginTop + chartHeight, marginLeft + chartWidth, marginTop + chartHeight); // X</span>

        // Labels eixos
<span class="nc" id="L902">        gc.setFill(javafx.scene.paint.Color.BLACK);</span>
<span class="nc" id="L903">        gc.fillText(&quot;Eleva√ß√£o (m)&quot;, 5, marginTop + chartHeight / 2);</span>
<span class="nc" id="L904">        gc.fillText(&quot;Dist√¢ncia (km)&quot;, marginLeft + chartWidth / 2 - 40, marginTop + chartHeight + 40);</span>

        // Desenhar perfil
<span class="nc" id="L907">        gc.setStroke(javafx.scene.paint.Color.BLUE);</span>
<span class="nc" id="L908">        gc.setLineWidth(2);</span>

<span class="nc bnc" id="L910" title="All 2 branches missed.">        for (int i = 0; i &lt; elevations.size() - 1; i++) {</span>
<span class="nc" id="L911">            double x1 = marginLeft + (distances.get(i) / maxDist) * chartWidth;</span>
<span class="nc" id="L912">            double y1 = marginTop + chartHeight - ((elevations.get(i) - minElev) / elevRange) * chartHeight;</span>
<span class="nc" id="L913">            double x2 = marginLeft + (distances.get(i + 1) / maxDist) * chartWidth;</span>
<span class="nc" id="L914">            double y2 = marginTop + chartHeight - ((elevations.get(i + 1) - minElev) / elevRange) * chartHeight;</span>

<span class="nc" id="L916">            gc.strokeLine(x1, y1, x2, y2);</span>
        }

        // Marcadores no eixo X
<span class="nc" id="L920">        gc.setFill(javafx.scene.paint.Color.BLACK);</span>
<span class="nc bnc" id="L921" title="All 2 branches missed.">        for (int i = 0; i &lt;= 5; i++) {</span>
<span class="nc" id="L922">            double dist = (maxDist / 5) * i;</span>
<span class="nc" id="L923">            double x = marginLeft + (dist / maxDist) * chartWidth;</span>
<span class="nc" id="L924">            gc.fillText(String.format(&quot;%.1f&quot;, dist), x - 10, marginTop + chartHeight + 20);</span>
        }

        // Marcadores no eixo Y
<span class="nc bnc" id="L928" title="All 2 branches missed.">        for (int i = 0; i &lt;= 5; i++) {</span>
<span class="nc" id="L929">            double elev = minElev + (elevRange / 5) * i;</span>
<span class="nc" id="L930">            double y = marginTop + chartHeight - (i / 5.0) * chartHeight;</span>
<span class="nc" id="L931">            gc.fillText(String.format(&quot;%.0f&quot;, elev), marginLeft - 50, y + 5);</span>
        }

<span class="nc" id="L934">        root.getChildren().addAll(stats, canvas);</span>

<span class="nc" id="L936">        Scene scene = new Scene(root, 850, 500);</span>
<span class="nc" id="L937">        chartStage.setScene(scene);</span>
<span class="nc" id="L938">        chartStage.show();</span>
<span class="nc" id="L939">    }</span>

    /**
     * Mostra um alerta com t√≠tulo e mensagem.
     * 
     * @param title
     * @param message
     */
    private void showAlert(String title, String message) {
<span class="nc" id="L948">        Alert alert = new Alert(Alert.AlertType.WARNING);</span>
<span class="nc" id="L949">        alert.setTitle(title);</span>
<span class="nc" id="L950">        alert.setHeaderText(null);</span>
<span class="nc" id="L951">        alert.setContentText(message);</span>
<span class="nc" id="L952">        alert.showAndWait();</span>
<span class="nc" id="L953">    }</span>

    // Reseta todos os dados e o mapa para o estado inicial.

    private void resetAll() {
<span class="nc bnc" id="L958" title="All 2 branches missed.">        if (originMarker != null)</span>
<span class="nc" id="L959">            mapView.removeMarker(originMarker);</span>
<span class="nc" id="L960">        originMarker = null;</span>

<span class="nc" id="L962">        clearWaypoints();</span>
<span class="nc" id="L963">        clearPOIsFromMap();</span>

<span class="nc bnc" id="L965" title="All 2 branches missed.">        if (currentRouteLine != null)</span>
<span class="nc" id="L966">            mapView.removeCoordinateLine(currentRouteLine);</span>
<span class="nc" id="L967">        currentRouteLine = null;</span>

<span class="nc" id="L969">        origemField.setText(&quot;&quot;);</span>
<span class="nc" id="L970">        pesquisaField.setText(&quot;&quot;);</span>
<span class="nc" id="L971">        routeSummaryLabel.setText(&quot;Defina origem e pontos de paragem...&quot;);</span>
<span class="nc" id="L972">        poiSummaryLabel.setText(&quot;Pontos de Interesse: 0&quot;);</span>

<span class="nc" id="L974">        mapView.setCenter(new Coordinate(38.7223, -9.1393));</span>
<span class="nc" id="L975">        mapView.setZoom(10);</span>
<span class="nc" id="L976">    }</span>

    private void showHistoryDialog() {
<span class="nc" id="L979">        Stage historyStage = new Stage();</span>
<span class="nc" id="L980">        historyStage.setTitle(&quot;Hist√≥rico de Rotas&quot;);</span>

<span class="nc" id="L982">        ListView&lt;com.myapp.model.HistoryEntry&gt; listView = new ListView&lt;&gt;();</span>
<span class="nc" id="L983">        listView.getItems().addAll(historyManager.getHistory());</span>

        // Bot√£o para carregar a rota selecionada
<span class="nc" id="L986">        Button btnLoad = new Button(&quot;Carregar Rota&quot;);</span>
<span class="nc" id="L987">        btnLoad.setDisable(true);</span>
<span class="nc" id="L988">        btnLoad.setStyle(&quot;-fx-background-color: #4CAF50; -fx-text-fill: white;&quot;);</span>

        // Bot√£o para limpar hist√≥rico
<span class="nc" id="L991">        Button btnClear = new Button(&quot;Limpar Hist√≥rico&quot;);</span>
<span class="nc" id="L992">        btnClear.setStyle(&quot;-fx-background-color: #f44336; -fx-text-fill: white;&quot;);</span>

<span class="nc" id="L994">        listView.getSelectionModel().selectedItemProperty().addListener((obs, oldVal, newVal) -&gt; {</span>
<span class="nc bnc" id="L995" title="All 2 branches missed.">            btnLoad.setDisable(newVal == null);</span>
<span class="nc" id="L996">        });</span>

        // A√ß√£o de carregar
<span class="nc" id="L999">        btnLoad.setOnAction(e -&gt; {</span>
<span class="nc" id="L1000">            com.myapp.model.HistoryEntry entry = listView.getSelectionModel().getSelectedItem();</span>
<span class="nc bnc" id="L1001" title="All 2 branches missed.">            if (entry != null) {</span>
<span class="nc" id="L1002">                loadRouteFromHistory(entry);</span>
<span class="nc" id="L1003">                historyStage.close();</span>
            }
<span class="nc" id="L1005">        });</span>

        // A√ß√£o de duplo clique na lista tamb√©m carrega
<span class="nc" id="L1008">        listView.setOnMouseClicked(e -&gt; {</span>
<span class="nc bnc" id="L1009" title="All 4 branches missed.">            if (e.getClickCount() == 2 &amp;&amp; listView.getSelectionModel().getSelectedItem() != null) {</span>
<span class="nc" id="L1010">                loadRouteFromHistory(listView.getSelectionModel().getSelectedItem());</span>
<span class="nc" id="L1011">                historyStage.close();</span>
            }
<span class="nc" id="L1013">        });</span>

        // A√ß√£o de limpar
<span class="nc" id="L1016">        btnClear.setOnAction(e -&gt; {</span>
<span class="nc" id="L1017">            historyManager.clearHistory();</span>
<span class="nc" id="L1018">            listView.getItems().clear();</span>
<span class="nc" id="L1019">        });</span>

<span class="nc" id="L1021">        HBox buttons = new HBox(10, btnLoad, btnClear);</span>
<span class="nc" id="L1022">        buttons.setAlignment(Pos.CENTER);</span>
<span class="nc" id="L1023">        buttons.setPadding(new Insets(10));</span>

<span class="nc" id="L1025">        VBox root = new VBox(10, new Label(&quot;As tuas rotas recentes:&quot;), listView, buttons);</span>
<span class="nc" id="L1026">        root.setPadding(new Insets(15));</span>

<span class="nc" id="L1028">        Scene scene = new Scene(root, 400, 500);</span>
<span class="nc" id="L1029">        historyStage.setScene(scene);</span>
<span class="nc" id="L1030">        historyStage.show();</span>
<span class="nc" id="L1031">    }</span>

    // Reconstr√≥i a UI e o Mapa a partir de um item do hist√≥rico

    private void loadRouteFromHistory(com.myapp.model.HistoryEntry entry) {
<span class="nc" id="L1036">        resetAll();</span>

<span class="nc bnc" id="L1038" title="All 2 branches missed.">        if (entry.getOrigin() != null) {</span>
<span class="nc" id="L1039">            Coordinate originCoord = new Coordinate(entry.getOrigin().getLatitude(), entry.getOrigin().getLongitude());</span>
<span class="nc" id="L1040">            setOrigin(originCoord);</span>
<span class="nc" id="L1041">            String name = entry.getOrigin().getName();</span>
<span class="nc bnc" id="L1042" title="All 2 branches missed.">            origemField.setText(name != null ? name : &quot;&quot;);</span>
        }

<span class="nc bnc" id="L1045" title="All 2 branches missed.">        if (entry.getWaypoints() != null) {</span>
<span class="nc bnc" id="L1046" title="All 2 branches missed.">            for (Point wp : entry.getWaypoints()) {</span>
<span class="nc" id="L1047">                addWaypoint(new Coordinate(wp.getLatitude(), wp.getLongitude()), wp.getName());</span>
<span class="nc" id="L1048">            }</span>
        }

<span class="nc bnc" id="L1051" title="All 2 branches missed.">        if (entry.getMode() != null) {</span>
<span class="nc" id="L1052">            selectedMode = entry.getMode();</span>
        }

<span class="nc" id="L1055">        Platform.runLater(this::calculateRoute);</span>
<span class="nc" id="L1056">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>